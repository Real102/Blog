(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{367:function(t,e,v){t.exports=v.p+"assets/img/visibilitychange.6390ab85.png"},430:function(t,e,v){"use strict";v.r(e);var _=v(45),a=Object(_.a)({},(function(){var t=this,e=t.$createElement,_=t._self._c||e;return _("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[_("h1",{attrs:{id:"用户在线时长统计方案思考"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#用户在线时长统计方案思考"}},[t._v("#")]),t._v(" 用户在线时长统计方案思考")]),t._v(" "),_("h2",{attrs:{id:"背景"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[t._v("#")]),t._v(" 背景")]),t._v(" "),_("p",[t._v("基于业务需求，需要设计一个统计用户访问某平台总时长的方案（基于 "),_("code",[t._v("vue")]),t._v(" 框架），这里记录下实现过程中的一些思考")]),t._v(" "),_("blockquote",[_("p",[t._v("Tips：【总时长】在本需求特指页面出现在屏幕可视区域内的情况")])]),t._v(" "),_("p",[t._v("目前主要从这两方面入手考虑：基于用户开始和结束访问平台的时间节点计算访问时长、基于每个页面的访问时长然后再合并为总的访问时长。如果有其他更好的实现方案，也请不吝赐教")]),t._v(" "),_("h2",{attrs:{id:"基于开始和结束访问的时间节点统计"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#基于开始和结束访问的时间节点统计"}},[t._v("#")]),t._v(" 基于开始和结束访问的时间节点统计")]),t._v(" "),_("p",[t._v("本方案主要是在 "),_("code",[t._v("App.vue")]),t._v(" 中利用 "),_("code",[t._v("created")]),t._v(" 和 "),_("code",[t._v("beforeDestory")]),t._v(" 两个钩子函数，当触发 "),_("code",[t._v("created")]),t._v(" 钩子时，记录开始访问的时间戳；当触发 "),_("code",[t._v("beforeDestory")]),t._v(" 钩子时记录结束访问的时间戳，计算出此次访问的总时长，然后再通过接口发送给后端记录")]),t._v(" "),_("p",[t._v("方案其实蛮简单的，不过简单的代价就是会存在比较多的问题")]),t._v(" "),_("ul",[_("li",[_("p",[t._v("该方案无法精确地记录到用户的结束访问时间")]),t._v(" "),_("p",[t._v("用户访问结束的时间除了正常的关闭标签页、关闭浏览器，还存在直接杀掉浏览器进程、关闭电脑等多种情况，如果用户在较长时间内没有触发平台的刷新或关闭，那么这段时间的访问时长将会丢失。如果使用 unload、beforeUnload 事件，也会有较多的"),_("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/sendBeacon#%E9%81%BF%E5%85%8D%E4%BD%BF%E7%94%A8_unload_%E5%92%8C_beforeunload",target:"_blank",rel:"noopener noreferrer"}},[t._v("兼容性"),_("OutboundLink")],1),t._v("的问题")])]),t._v(" "),_("li",[_("p",[t._v("多标签页同时打开平台时，访问时间重合的问题")]),t._v(" "),_("p",[t._v("当平台触发新标签页打开或手动新开标签页访问平台时，访问的开始时间与结束时间便会产生重合，这部分的重合会导致访问时长的大大增长，甚至出现某天的访问时长超过 "),_("code",[t._v("24")]),t._v(" 小时")])]),t._v(" "),_("li",[_("p",[t._v("页面切后台时无法判断")]),t._v(" "),_("p",[t._v("当切换到其他标签页或其他软件时，平台处于后台运行状态，这时候的访问时长不应该被计算到访问总时长中去，即不承认“"),_("strong",[t._v("挂机")]),t._v("”行为")])])]),t._v(" "),_("h2",{attrs:{id:"基于每个页面的访问时长统计"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#基于每个页面的访问时长统计"}},[t._v("#")]),t._v(" 基于每个页面的访问时长统计")]),t._v(" "),_("p",[t._v("本方案主要是借助路由的钩子 "),_("code",[t._v("beforeEach")]),t._v(" 实现。当页面跳转时，"),_("code",[t._v("beforeEach")]),t._v(" 钩子会记录来源地址与去往地址，也就相当于获取到来源地址的访问结束时间 "),_("code",[t._v("endTime")]),t._v(" 与去往地址的开始访问时间 "),_("code",[t._v("endTime")])]),t._v(" "),_("p",[t._v("虽然同样是比较简单的方案，但从准确性上来说有了一定的提升：")]),t._v(" "),_("ul",[_("li",[_("p",[t._v("降低了异常关闭页面带来的访问时长误差")]),t._v(" "),_("p",[t._v("相较于第一种方案，已经将误差缩小到最后一个访问页面")])]),t._v(" "),_("li",[_("p",[t._v("更细粒度地统计访问时长")]),t._v(" "),_("p",[t._v("可以更直观的看到用户在每个页面的停留时长，并且可以根据访问时长的变化分析用户对功能调整的 “"),_("strong",[t._v("满意程度/接受程度")]),t._v("”")])])]),t._v(" "),_("p",[_("strong",[t._v("但")]),t._v(" 同样也存在问题：")]),t._v(" "),_("ul",[_("li",[_("p",[t._v("对于方案一中的缺陷仍未解决")])]),t._v(" "),_("li",[_("p",[t._v("接口请求较为频繁")]),t._v(" "),_("p",[t._v("每个页面的跳转与刷新都会触发一次埋点，如果是使用 "),_("code",[t._v("ajax")]),t._v(" 的方式提交，那么每跳转一次页面就提交一次 "),_("code",[t._v("ajax")]),t._v(" 请求")])])]),t._v(" "),_("p",[t._v("我们发现，两种方案其实都无法处理多标签页、切后台的情况，因此我们需要借助其他的 “"),_("strong",[t._v("能力")]),t._v("” 来实现")]),t._v(" "),_("h2",{attrs:{id:"visibilitychange-事件"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#visibilitychange-事件"}},[t._v("#")]),t._v(" visibilitychange 事件")]),t._v(" "),_("p",[t._v("通过页面的可见状态，可以认定为此时平台正在“"),_("strong",[t._v("被使用")]),t._v("”；当页面状态为隐藏时，可以认定为此时平台已退出或正在挂机。")]),t._v(" "),_("p",[t._v("当页面的可见性发生变更时，会触发 "),_("code",[t._v("visibilitychange")]),t._v(" 事件，再利用 "),_("code",[t._v("document.hidden")]),t._v(" 属性判断当前页面是处于可见还是隐藏状态，我们也就可以轻易的在切换过程中记录到可见状态下持续的时长，而这就是我们需要的真正的访问时长")]),t._v(" "),_("p",[_("strong",[t._v("兼容方面")]),t._v("：")]),t._v(" "),_("p",[_("img",{attrs:{src:v(367),alt:"visibilitychange",title:"visibilitychange"}})]),t._v(" "),_("p",[_("a",{attrs:{href:"https://caniuse.com/?search=visibilitychange",target:"_blank",rel:"noopener noreferrer"}},[t._v("can i use"),_("OutboundLink")],1),t._v(" 网站上检测的效果，"),_("code",[t._v("visibilitychange")]),t._v(" 属性的覆盖率都有 "),_("code",[t._v("95%")]),t._v(" 左右（"),_("code",[t._v("Safari")]),t._v(" 浏览器为部分兼容，跟用法有关）基本覆盖主流浏览器。在编码实现前参考了网上的一些代码，增加了浏览器前缀。具体如下：")]),t._v(" "),_("div",{staticClass:"language-javascript extra-class"},[_("pre",{pre:!0,attrs:{class:"language-javascript"}},[_("code",[t._v("document"),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),_("span",{pre:!0,attrs:{class:"token function"}},[t._v("addEventListener")]),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),_("span",{pre:!0,attrs:{class:"token string"}},[t._v('"visibilitychange"')]),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),_("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),_("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" hiddenProperty "),_("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n    "),_("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hidden"')]),t._v(" "),_("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" document\n      "),_("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),_("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hidden"')]),t._v("\n      "),_("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),_("span",{pre:!0,attrs:{class:"token string"}},[t._v('"webkitHidden"')]),t._v(" "),_("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" document\n      "),_("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),_("span",{pre:!0,attrs:{class:"token string"}},[t._v('"webkitHidden"')]),t._v("\n      "),_("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),_("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mozHidden"')]),t._v(" "),_("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" document\n      "),_("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),_("span",{pre:!0,attrs:{class:"token string"}},[t._v('"mozHidden"')]),t._v("\n      "),_("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),_("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n  "),_("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("document"),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("hiddenProperty"),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),_("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 可见情况下 xxx")]),t._v("\n  "),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),_("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),_("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 隐藏情况下 xxx")]),t._v("\n  "),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),_("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),_("p",[t._v("此外，触发页面隐藏的情况有很多种如："),_("code",[t._v("alt+tab")]),t._v(" 切换、点击"),_("code",[t._v("-")]),t._v("缩小浏览器、"),_("code",[t._v("win+D")]),t._v(" 返回桌面、"),_("code",[t._v("alt+F4")]),t._v("关闭程序等，"),_("strong",[t._v("以当前最新版本的浏览器进行测试")]),t._v("，罗列出 "),_("code",[t._v("visibilitychange")]),t._v(" 可能被触发的情况，兼容如下：")]),t._v(" "),_("table",[_("thead",[_("tr",[_("th",[t._v("浏览器关闭方式")]),t._v(" "),_("th",[t._v("鼠标点击切换")]),t._v(" "),_("th",[t._v("alt+tab 切换")]),t._v(" "),_("th",[t._v("点击-缩小")]),t._v(" "),_("th",[t._v("win+D 返回桌面")]),t._v(" "),_("th",[t._v("× 按钮关闭")]),t._v(" "),_("th",[t._v("alt+F4 关闭程序")]),t._v(" "),_("th",[t._v("刷新")])])]),t._v(" "),_("tbody",[_("tr",[_("td",[t._v("Chrome")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")])]),t._v(" "),_("tr",[_("td",[t._v("火狐")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("×")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")])]),t._v(" "),_("tr",[_("td",[t._v("Edge")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")])]),t._v(" "),_("tr",[_("td",[t._v("Opera")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")])]),t._v(" "),_("tr",[_("td",[t._v("360")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("×")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")]),t._v(" "),_("td",[t._v("√")])])])]),t._v(" "),_("p",[t._v("经过测试，发现 "),_("code",[t._v("alt+tab")]),t._v(" 在火狐浏览器和 "),_("code",[t._v("360")]),t._v(" 系浏览器下都无法触发 "),_("code",[t._v("visibilitychange")]),t._v(" 事件，而其余的情况都会触发 "),_("code",[t._v("visibilitychange")]),t._v(" 事件，同样也无法通过监听键盘的 "),_("code",[t._v("alt+tab")]),t._v(" 事件来获取可见状态的变化。这种情况下就只能根据业务需求来调整实现方案，无法做到完全兼容（"),_("code",[t._v("alt+tab")]),t._v(" 使用率较低，且如果是利用路由守卫方案，可以通过校验单一页面访问时长，将异常的访问时长剔除，以此来降低误差情况，这也算是一个不完全的解决方案吧）")]),t._v(" "),_("p",[t._v("至此，可以发现方案一中存在的问题几乎都得到了解决；而方案二中并发量的问题，思考一下其实我们可以将每个页面的访问时长缓存起来（"),_("code",[t._v("localstorage")]),t._v("）然后在触发 "),_("code",[t._v("visibilitychange")]),t._v(" 事件后统一提交埋点数据，这样也可以一定程度缓解并发的压力")]),t._v(" "),_("p",[t._v("接下来考虑的是如何提交埋点的问题")]),t._v(" "),_("h2",{attrs:{id:"埋点提交"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#埋点提交"}},[t._v("#")]),t._v(" 埋点提交")]),t._v(" "),_("ul",[_("li",[_("p",[_("code",[t._v("sendBeacon")])]),t._v(" "),_("p",[t._v("埋点提交通常会使用 "),_("code",[t._v("ajax")]),t._v("，但需要考虑到一点：当页面关闭时，相当于完成了一个访问周期，这时需要将本地的访问时长提交到后端。如果是通过 "),_("code",[t._v("ajax")]),t._v(" 提交，在页面关闭的同时，"),_("code",[t._v("ajax")]),t._v(" 的请求也会被中断，可以考虑使用 "),_("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/sendBeacon",target:"_blank",rel:"noopener noreferrer"}},[t._v("sendBeacon"),_("OutboundLink")],1),t._v("即便浏览器关闭也可以正常将数据提交到后端")])]),t._v(" "),_("li",[_("p",[_("code",[t._v("1*1")]),t._v(" 空白 "),_("code",[t._v("gif")]),t._v(" 图")]),t._v(" "),_("p",[t._v("空白 "),_("code",[t._v("gif")]),t._v(" 图提交埋点也是一个比较好的方案，但对于关闭浏览器是否会中断请求的问题，参考网上的说法是"),_("a",{attrs:{href:"https://github.com/Advanced-Frontend/Daily-Interview-Question/issues/87#issuecomment-516857900",target:"_blank",rel:"noopener noreferrer"}},[t._v("部分兼容"),_("OutboundLink")],1),t._v("（"),_("strong",[t._v("没有实测过")]),t._v("）具体的优势可以查看 "),_("a",{attrs:{href:"https://github.com/Advanced-Frontend/Daily-Interview-Question/issues/87",target:"_blank",rel:"noopener noreferrer"}},[t._v("Github 文档"),_("OutboundLink")],1)])]),t._v(" "),_("li",[_("p",[_("code",[t._v("websocket")])]),t._v(" "),_("p",[t._v("如果埋点提交较频繁且埋点数量较多时，可以考虑使用 "),_("a",{attrs:{href:"https://www.ruanyifeng.com/blog/2017/05/websocket.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("websocket"),_("OutboundLink")],1)])])]),t._v(" "),_("h2",{attrs:{id:"结论"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#结论"}},[t._v("#")]),t._v(" 结论")]),t._v(" "),_("p",[t._v("总的来说，如果需求侧不需要分析每个页面的访问时长，那么方案一会更适合一些；而方案二的优势在于埋点数据更加详细，缺陷也就是并发的问题（ "),_("code",[t._v("localstorage")]),t._v(" 缓存或 "),_("code",[t._v("websocket")]),t._v(" 可以一定程度解决）")]),t._v(" "),_("p",[t._v("以上两种方案都会存在一些误差，不能够准确地统计真正的在线时长，所以，我们能做的也只是尽可能的缩小误差。")]),t._v(" "),_("h2",{attrs:{id:"参考文档"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#参考文档"}},[t._v("#")]),t._v(" 参考文档")]),t._v(" "),_("ul",[_("li",[_("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/sendBeacon#%E9%81%BF%E5%85%8D%E4%BD%BF%E7%94%A8_unload_%E5%92%8C_beforeunload",target:"_blank",rel:"noopener noreferrer"}},[t._v("unload、beforeUnload 兼容性问题"),_("OutboundLink")],1)]),t._v(" "),_("li",[_("a",{attrs:{href:"https://caniuse.com/?search=visibilitychange",target:"_blank",rel:"noopener noreferrer"}},[t._v("can i use"),_("OutboundLink")],1)]),t._v(" "),_("li",[_("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/sendBeacon",target:"_blank",rel:"noopener noreferrer"}},[t._v("sendBeacon"),_("OutboundLink")],1)]),t._v(" "),_("li",[_("a",{attrs:{href:"https://github.com/Advanced-Frontend/Daily-Interview-Question/issues/87",target:"_blank",rel:"noopener noreferrer"}},[t._v("空白 gif 图提交埋点"),_("OutboundLink")],1)]),t._v(" "),_("li",[_("a",{attrs:{href:"https://www.ruanyifeng.com/blog/2017/05/websocket.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("websocket"),_("OutboundLink")],1)])]),t._v(" "),_("h2",{attrs:{id:"写在最后"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#写在最后"}},[t._v("#")]),t._v(" 写在最后")]),t._v(" "),_("p",[t._v("如果对以上内容有意见或建议，欢迎指教")]),t._v(" "),_("p",[t._v("我是枸哥，可以叫我杞爷")])])}),[],!1,null,null,null);e.default=a.exports}}]);