# 笔记

## 2022 年 3 月 1 日

### ES6 Module 动态加载

`ES6` 模块是编译时加载，`CommonJS` 和 `AMD` 则是运行时加载。

`ES2020` 提案引入了 `import()` 函数，支持动态加载模块，并且 `import()` 返回的是一个 `Promise` 对象

```javascript
const main = document.querySelector("main")
import(`./section-modules/${someVariable}.js`)
  .then(module => {
    module.loadPageInto(main)
  })
  .catch(err => {
    main.textContent = err.message
  })
```

- `import()` 函数可以用在任何地方，不仅仅是模块，非模块的脚本也可以使用。它是运行时执行
- `import()` 函数与所加载的模块没有静态连接关系，这点也是与 `import` 语句不相同
- `import()` 类似于 `Node` 的 `require` 方法，区别主要是前者是异步加载，后者是同步加载

`import()` 加载模块成功以后，这个模块会作为一个对象，当作 `then` 方法的参数。因此，可以使用对象解构赋值的语法，获取输出接口。

```javascript
import("./myModule.js").then(({ export1, export2 }) => {
  // ...·
})
// 如果模块有 default 输出接口，可以用参数直接获得
import("./myModule.js").then(myModule => {
  console.log(myModule.default)
})
// 在 async 函数之中
async function main() {
  const myModule = await import("./myModule.js")
  const { export1, export2 } = await import("./myModule.js")
  const [module1, module2, module3] = await Promise.all([
    import("./module1.js"),
    import("./module2.js"),
    import("./module3.js")
  ])
}
main()
```

## 2022 年 3 月 2 日

### ES6 模块与 CommonJS 模块的差异

- `CommonJS` 模块输出的是一个值的拷贝，`ES6` 模块输出的是值的引用
- `CommonJS` 模块是运行时加载，`ES6` 模块是编译时输出接口
- `CommonJS` 模块的 `require()` 是同步加载模块，`ES6` 模块的 `import` 命令是异步加载，有一个独立的模块依赖的解析阶段

`JavaScript` 现在有两种模块。一种是 `ES6` 模块，简称 `ESM`；另一种是 `CommonJS` 模块，简称 `CJS`

`CommonJS` 模块是 `Node.js` 专用的，与 `ES6` 模块不兼容。语法上面，两者最明显的差异是：`CommonJS` 模块使用 `require()` 和 `module.exports`，`ES6` 模块使用 `import` 和 `export`

从 `Node.js v13.2` 版本开始，`Node.js` 已经默认打开了 `ES6` 模块支持。`Node.js` 要求 `ES6` 模块采用 `.mjs` 后缀文件名。也就是说，只要脚本文件里面使用 `import` 或者 `export` 命令，那么就必须采用 `.mjs` 后缀名。`Node.js` 遇到 `.mjs` 文件，就认为它是 `ES6` 模块。如果不希望将后缀名改成 `.mjs`，可以在项目的 `package.json` 文件中，指定 `type` 字段为 `module`。一旦设置了以后，该项目的 `JS` 脚本，就被解释成 `ES6` 模块。

```json
{
  "type": "module"
}
```

如果这时还要使用 `CommonJS` 模块，那么需要将 `CommonJS` 脚本的后缀名都改成 `.cjs`。如果没有 `type` 字段，或者 `type` 字段为 `commonjs`，则 · 脚本会被解释成 `CommonJS` 模块。

总结为一句话：`.mjs` 文件总是以 `ES6` 模块加载，`.cjs` 文件总是以 `CommonJS` 模块加载，`.js` 文件的加载取决于 · 里面 `type` 字段的设置。

- `CommonJS` 模块加载 `ES6` 模块

`CommonJS` 的 `require()` 命令不能加载 `ES6` 模块，会报错，只能使用 `import()` 这个方法加载。

```javascript
;(async () => {
  await import("./my-app.mjs")
})()
```

- `ES6` 模块加载 `CommonJS` 模块
