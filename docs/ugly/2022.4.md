# 笔记

## 2022 年 4 月 1 日

### 统计网站在线时长思考

常规方法：通过监听 `beforeUnload` 方法，判断用户退出或关闭页面的操作，但会有以下几点问题

- 当直接关闭浏览器或关闭电脑时，无法监听 `beforeUnload` 事件
- `beforeUnload` 事件兼容性问题，各个浏览器的表现行为不一致

其他方法：开启一个定时器，每隔一段时间（`1/5/10min`）记录结束时间 `endTime`到 `localstorage`，进入平台记录开始时间 `startTime`，当可以正常监听到 `beforeUnload` 事件时，可以通过 `sendBeacon` 方法提交到后端；若页面非正常关闭时，可以在下一次访问页面时再提交这个访问时间

存在优势：

- 能够保证非正常关闭页面情况下数据不丢失
- 数据误差较小（`1/5/10min`）

存在劣势：

- 非正常关闭页面情况下，需要下一次访问才能将上一次的访问时间发送给后端
- 在同时打开多页面的情况下，会产生重复数据，难以去重

onvisibilitychange 兼容性研究

|        | 鼠标点击 tab 切换 | alt+tab 切换程序 | 点击-缩小浏览器 | win+D 缩小浏览器 | × 关闭浏览器 | alt+F4 关闭浏览器 | 刷新 |
| ------ | ----------------- | ---------------- | --------------- | ---------------- | ------------ | ----------------- | ---- |
| Chrome | √                 | √                | √               | √                | √            | √                 | √    |
| 火狐   | √                 | ×                | √               | √                | √            | √                 | √    |
| Edge   | √                 | √                | √               | √                | √            | √                 | √    |
| Opera  | √                 | √                | √               | √                | √            | √                 | √    |

## 2022 年 4 月 2 日

### JS 保存快捷方式思考

pc 端保存当前页面到桌面，参考代码如下（来源于百度），利用桌面快捷方式为 `.url` 后缀的文件，模拟点击事件生成这么一个文件而达到“桌面快捷方式”的目的

```javascript
function urlDownload(content, fileName) {
  const eleLink = document.createElement("a")
  eleLink.download = fileName
  eleLink.style.display = "none"
  const blob = new Blob([content])
  eleLink.href = URL.createObjectURL(blob)
  document.body.appendChild(eleLink)
  eleLink.click()
  document.body.removeChild(eleLink)
}
const title = document.title
const { protocol, href, hostname } = location
const content = `[{000214A0-0000-0000-C000-000000000046}]
  Prop3=19,11
  [InternetShortcut]
  IDList=
  URL=${href}
  IconFile=${protocol}//${hostname}/favicon.ico
  IconIndex=1`
```

移动端 `JavaScript` 应该没有提供这个能力，需要在桌面生成快捷方式（原子组件），应该是属于 `APP` 的能力，而 `JavaScript`（非 `node`） 只是基于浏览器运行的，没有那么高的权限来操作系统

谷歌了之后发现 `PWA` 也有这个能力，是基于 [A2HS](https://developer.mozilla.org/zh-CN/docs/Web/Progressive_web_apps/Add_to_home_screen) 实现的能力（`PC` 端也可以下载，但展示形式有点不太一样）

## 2022 年 4 月 3 日

### unknown 类型

`TypeScript 3.0` 引入了一个顶级的 `unknown` 类型。 对照于 `any`，`unknown` 是类型安全的。 任何值都可以赋给 `unknown`，但是当没有类型断言或基于控制流的类型细化时 `unknown` 不可以赋值给其它类型，除了它自己和 `any` 外。 同样地，在 `unknown` 没有被断言或细化到一个确切类型之前，是不允许在其上进行任何操作的。

```javascript
const getDogName = () => {
 let x: unknown;
 return x;
};

const dogName = getDogName();
console.log((dogName as string).toLowerCase());
```

参考文档地址：<https://www.tslang.cn/docs/release-notes/typescript-3.0.html>
